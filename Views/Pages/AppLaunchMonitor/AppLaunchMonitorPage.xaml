<Page x:Class="Tools.Views.Pages.AppLaunchMonitor.AppLaunchMonitorPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
      xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
      xmlns:local="clr-namespace:Tools.Views.Pages.AppLaunchMonitor"
      xmlns:viewModel="clr-namespace:Tools.ViewModel.AppLaunchMonitor"
      xmlns:converters="clr-namespace:Tools.Converters"
      mc:Ignorable="d"
      d:DesignHeight="750"
      d:DesignWidth="692"
      ui:Design.Background="{DynamicResource ApplicationBackgroundBrush}"
      ui:Design.Foreground="{DynamicResource TextFillColorPrimaryBrush}"
      d:DataContext="{d:DesignInstance Type=viewModel:AppLaunchMonitorViewModel}"
      Title="AppLaunchMonitorPage">

    <Page.Resources>
        <converters:ProcessStatusToColorConverter x:Key="ProcessStatusToColorConverter" />
        <converters:ProcessStatusToIconConverter x:Key="ProcessStatusToIconConverter" />
        <converters:ProcessStatusToTextConverter x:Key="ProcessStatusToTextConverter" />
        <converters:BooleanToVisibleConverter x:Key="BooleanToVisibleConverter" />
    </Page.Resources>

    <Grid Margin="42, 16">
        <Grid.RowDefinitions>
            <RowDefinition Height="60" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- 标题区域 -->
        <Grid Grid.Row="0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <!-- 标题图标 -->
            <ui:SymbolIcon Grid.Row="0" Grid.RowSpan="2" Grid.Column="0" Symbol="WindowPlay20"
                           Filled="True" FontSize="24"
                           Margin="0,0,12,0"
                           Foreground="#4CAF50" />

            <!-- 标题文本 -->
            <ui:TextBlock Grid.Row="0" Grid.Column="1" Text="App启动监控"
                          FontTypography="Title" FontSize="24"
                          VerticalAlignment="Center"
                          Foreground="{DynamicResource TextFillColorPrimaryBrush}" />
            <!-- 副标题 -->
            <ui:TextBlock Grid.Row="1" Grid.Column="1" Text="可以选择需要监视的应用，如果今天没有启动它们，程序在后台会定时提醒你"
                          FontTypography="BodyStrong" VerticalAlignment="Center"
                          Foreground="{DynamicResource TextFillColorSecondaryBrush}" />
            <!-- 设置按钮 -->
            <ui:Button Grid.Row="0" Grid.Column="2" Grid.RowSpan="2"
                       Icon="{ui:SymbolIcon Settings24, FontSize=22, Filled=True}"
                       Margin="5,0" Padding="8" Width="42" Height="42"
                       Foreground="{DynamicResource TextFillColorPrimaryBrush}"
                       Background="Transparent" BorderBrush="Transparent"
                       Command="{Binding SettingAppLaunchMonitorCommand}" />
        </Grid>

        <ui:Border Grid.Row="1" Grid.Column="0" Margin="0,16"
                   Background="{DynamicResource SolidBackgroundFillColorSecondaryBrush}"
                   CornerRadius="12"
                   BorderThickness="1"
                   BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <!-- 列表标题、统计和工具栏 -->
                <ui:Border Grid.Row="0"
                           Background="{DynamicResource SolidBackgroundFillColorTertiaryBrush}"
                           CornerRadius="12,12,0,0"
                           Padding="16,12">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <!-- 标题和图标 -->
                        <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                            <ui:SymbolIcon Symbol="List24"
                                           FontSize="16"
                                           Margin="0,0,8,0"
                                           Foreground="{DynamicResource TextFillColorSecondaryBrush}" />
                            <ui:TextBlock Text="已监视的应用"
                                          FontWeight="SemiBold"
                                          Foreground="{DynamicResource TextFillColorPrimaryBrush}" />
                        </StackPanel>

                        <!-- 统计信息 -->
                        <ui:TextBlock Grid.Column="1"
                                      Text="{Binding MonitoredApps.Count, StringFormat='共 {0} 个应用'}"
                                      FontSize="12"
                                      Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                      VerticalAlignment="Center"
                                      HorizontalAlignment="Center" />

                        <!-- 工具栏按钮 -->
                        <StackPanel Grid.Column="2" Orientation="Horizontal">
                            <ui:Button Icon="{ui:SymbolIcon ArrowSync24}"
                                       Content="刷新并检测当前进程" Margin="0,0,8,0"
                                       Appearance="Secondary"
                                       Command="{Binding RefreshAndCheckCommand}" />

                            <ui:Button Icon="{ui:SymbolIcon Add24}"
                                       Content="添加监视应用"
                                       Appearance="Primary"
                                       Command="{Binding AddMonitorWindowCommand}" />
                        </StackPanel>
                    </Grid>
                </ui:Border>

                <!-- 应用列表容器 -->
                <ui:DynamicScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" Padding="8">
                    <Grid>
                        <ItemsControl ItemsSource="{Binding MonitoredApps}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <ui:Border Background="Transparent"
                                               CornerRadius="8"
                                               Margin="0,4"
                                               Padding="8">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto" />
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="Auto" />
                                                <ColumnDefinition Width="Auto" />
                                                <ColumnDefinition Width="Auto" />
                                            </Grid.ColumnDefinitions>

                                            <!-- 应用图标 -->
                                            <Image Grid.Column="0"
                                                   Source="{Binding Icon}"
                                                   Width="32"
                                                   Height="32"
                                                   Margin="0,0,12,0" />

                                            <!-- 应用信息 -->
                                            <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                <ui:TextBlock Text="{Binding DisplayTitle}"
                                                              FontWeight="SemiBold" TextWrapping="Wrap"
                                                              Foreground="{DynamicResource TextFillColorPrimaryBrush}"
                                                              TextTrimming="CharacterEllipsis" />
                                                <ui:TextBlock Text="{Binding ProcessName}"
                                                              FontSize="11" TextWrapping="Wrap"
                                                              Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                                              TextTrimming="CharacterEllipsis" />
                                            </StackPanel>

                                            <!-- 最后检查时间 -->
                                            <ui:TextBlock Grid.Column="2"
                                                          FontSize="12" Margin="8,0,12,0" TextWrapping="Wrap"
                                                          Text="{Binding DescribeText}" Width="120"
                                                          Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                                          VerticalAlignment="Center" />

                                            <!-- 状态指示器 -->
                                            <ui:Border Grid.Column="3"
                                                       Background="{Binding HasStartToday, Converter={StaticResource ProcessStatusToColorConverter}}"
                                                       CornerRadius="4" Padding="6,2"
                                                       Margin="0,0,12,0"
                                                       VerticalAlignment="Center">
                                                <StackPanel Orientation="Horizontal">
                                                    <ui:SymbolIcon
                                                        Symbol="{Binding HasStartToday, Converter={StaticResource ProcessStatusToIconConverter}}"
                                                        FontSize="16" Margin="0,0,4,0" Filled="True"
                                                        Foreground="White" />
                                                    <ui:TextBlock
                                                        Text="{Binding HasStartToday, Converter={StaticResource ProcessStatusToTextConverter}}"
                                                        FontSize="14" FontWeight="SemiBold"
                                                        VerticalAlignment="Center"
                                                        Foreground="White" />
                                                </StackPanel>
                                            </ui:Border>

                                            <!-- 操作菜单按钮 -->
                                            <ui:Flyout Grid.Column="4"
                                                       IsOpen="{Binding IsOperateMenuOpen, Mode=TwoWay}"
                                                       Placement="Top">
                                                <Grid Margin="4">
                                                    <Grid.RowDefinitions>
                                                        <RowDefinition Height="Auto" />
                                                        <RowDefinition Height="Auto" />
                                                        <RowDefinition Height="Auto" />
                                                        <RowDefinition Height="Auto" />
                                                    </Grid.RowDefinitions>
                                                    <ui:Button Grid.Row="0"
                                                               Icon="{ui:SymbolIcon Edit16, Filled=True}"
                                                               Content="设置备注名"
                                                               Margin="0,0,0,8"
                                                               Command="{Binding DataContext.SetRemarksTitleCommand, RelativeSource={RelativeSource FindAncestor, AncestorType=local:AppLaunchMonitorPage}}"
                                                               CommandParameter="{Binding}" />
                                                    <ui:Button Grid.Row="1"
                                                               Icon="{ui:SymbolIcon Checkmark12, Filled=True}"
                                                               Content="手动标记为已启动" Appearance="Success"
                                                               Margin="0,0,0,8"
                                                               Command="{Binding DataContext.HasStartCommand, RelativeSource={RelativeSource FindAncestor, AncestorType=local:AppLaunchMonitorPage}}"
                                                               CommandParameter="{Binding}" />
                                                    <ui:Button Grid.Row="2"
                                                               Icon="{ui:SymbolIcon Dismiss16, Filled=True}"
                                                               Content="手动标记为未启动" Margin="0,0,0,8"
                                                               Command="{Binding DataContext.HasNotStartCommand, RelativeSource={RelativeSource FindAncestor, AncestorType=local:AppLaunchMonitorPage}}"
                                                               CommandParameter="{Binding}" />
                                                    <ui:Button Grid.Row="3" Appearance="Danger" Content="取消监视"
                                                               Command="{Binding DataContext.CancelMonitorCommand, RelativeSource={RelativeSource FindAncestor, AncestorType=local:AppLaunchMonitorPage}}"
                                                               CommandParameter="{Binding}" />
                                                </Grid>
                                            </ui:Flyout>
                                            <ui:Button Grid.Column="4"
                                                       Icon="{ui:SymbolIcon MoreHorizontal16}"
                                                       Appearance="Secondary"
                                                       Command="{Binding DataContext.OpenOperateMenuCommand, RelativeSource={RelativeSource FindAncestor, AncestorType=local:AppLaunchMonitorPage}}"
                                                       CommandParameter="{Binding}"
                                                       Width="32" Height="32" />
                                        </Grid>
                                    </ui:Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>

                        <!-- 空状态提示 -->
                        <ui:Border Background="Transparent"
                                   Visibility="{Binding HasMonitoredApps, Converter={StaticResource BooleanToVisibleConverter}, ConverterParameter=True}"
                                   VerticalAlignment="Center" HorizontalAlignment="Center">
                            <StackPanel HorizontalAlignment="Center">
                                <ui:SymbolIcon Symbol="AppFolder24"
                                               FontSize="48" Margin="0,0,0,12"
                                               Foreground="{DynamicResource TextFillColorTertiaryBrush}"
                                               HorizontalAlignment="Center" />
                                <ui:TextBlock Text="暂无监视的应用"
                                              FontSize="14" Margin="0,0,0,12"
                                              Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                              HorizontalAlignment="Center" />
                                <ui:TextBlock Text="点击上方「添加监视应用」按钮开始监视应用"
                                              FontSize="12"
                                              Foreground="{DynamicResource TextFillColorTertiaryBrush}"
                                              HorizontalAlignment="Center"
                                              TextAlignment="Center" />
                            </StackPanel>
                        </ui:Border>
                    </Grid>
                </ui:DynamicScrollViewer>
            </Grid>
        </ui:Border>

        <!-- 状态栏 -->
        <ui:Border Grid.Row="2"
                   Background="{DynamicResource SolidBackgroundFillColorSecondaryBrush}"
                   CornerRadius="8" BorderThickness="1"
                   BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                   Margin="0,16,0,0">
            <Grid Margin="12,8">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <!-- 最后检查时间 -->
                <ui:TextBlock Grid.Column="0"
                              Text="{Binding LastCheckTime, StringFormat='最后检查: {0:HH:mm:ss}'}"
                              FontSize="12"
                              Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                              VerticalAlignment="Center" />

                <!-- 今日统计 -->
                <ui:TextBlock Grid.Column="1"
                              Text="{Binding TodayLaunchCount, StringFormat='今日启动: {0} 个应用'}"
                              FontSize="12"
                              Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                              VerticalAlignment="Center"
                              Margin="12,0,0,0" />
            </Grid>
        </ui:Border>
    </Grid>
</Page>
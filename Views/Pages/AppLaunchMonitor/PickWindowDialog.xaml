<ui:FluentWindow x:Class="Tools.Views.Pages.AppLaunchMonitor.PickWindowDialog"
                 xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                 xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                 xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
                 xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
                 xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
                 xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
                 xmlns:viewModel="clr-namespace:Tools.ViewModel.AppLaunchMonitor"
                 xmlns:controls="clr-namespace:Tools.Controls"
                 xmlns:converters="clr-namespace:Tools.Converters"
                 xmlns:b="clr-namespace:Tools.Behaviors"
                 xmlns:local="clr-namespace:Tools.Views.Pages.AppLaunchMonitor"
                 mc:Ignorable="d"
                 Title="PickWindowDialog"
                 MinHeight="600"
                 MinWidth="800"
                 MaxHeight="600"
                 MaxWidth="800"
                 d:DataContext="{d:DesignInstance Type=viewModel:PickWindowDialogViewModel}"
                 ui:Design.Background="{DynamicResource ApplicationBackgroundBrush}"
                 ui:Design.Foreground="{DynamicResource TextFillColorPrimaryBrush}"
                 WindowStartupLocation="CenterOwner"
                 ShowInTaskbar="False">
    <Window.Resources>
        <converters:BooleanToVisibleConverter x:Key="BooleanToVisibleConverter" />
    </Window.Resources>

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- 标题栏 -->
        <ui:Border Grid.Row="0"
                   BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                   BorderThickness="0,0,0,1"
                   Padding="20,16">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <!-- 标题和图标 -->
                <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                    <ui:SymbolIcon Symbol="WindowMultiple20"
                                   Filled="True" FontSize="20"
                                   Margin="0,0,12,0"
                                   Foreground="#4CAF50" />
                    <StackPanel>
                        <ui:TextBlock Text="选择要监视的窗口"
                                      FontTypography="Title"
                                      FontSize="18"
                                      Foreground="{DynamicResource TextFillColorPrimaryBrush}" />
                        <ui:TextBlock Text="点击窗口可查看实时预览，双击或点击确定按钮选择"
                                      FontSize="12"
                                      Foreground="{DynamicResource TextFillColorSecondaryBrush}" />
                    </StackPanel>
                </StackPanel>

                <!-- 工具栏 -->
                <StackPanel Grid.Column="2" Orientation="Horizontal">
                    <ui:Button Icon="{ui:SymbolIcon ArrowSync24}"
                               Content="刷新" Margin="0,0,8,0"
                               Appearance="Secondary"
                               Command="{Binding RefreshCommand}"
                               ToolTip="刷新窗口列表" />

                    <ui:Button Icon="{ui:SymbolIcon Search24}"
                               Content="搜索"
                               Appearance="Secondary"
                               Command="{Binding ToggleSearchCommand}"
                               ToolTip="搜索窗口" />
                </StackPanel>
            </Grid>
        </ui:Border>

        <!-- 搜索框 -->
        <ui:Border Grid.Row="1"
                   Background="{DynamicResource SolidBackgroundFillColorTertiaryBrush}"
                   BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                   BorderThickness="0,0,0,1"
                   Padding="20,8" CornerRadius="12,12,0,0"
                   Visibility="{Binding IsSearchVisible, Converter={StaticResource BooleanToVisibleConverter}}">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <ui:TextBox Grid.Column="0"
                            Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                            PlaceholderText="输入窗口标题或进程名进行搜索..."
                            Icon="{ui:SymbolIcon Search24}" />

                <ui:Button Grid.Column="1"
                           Icon="{ui:SymbolIcon Dismiss24}"
                           Appearance="Secondary"
                           Command="{Binding ClearSearchCommand}"
                           Margin="8,0,0,0"
                           ToolTip="清除搜索" />
            </Grid>
        </ui:Border>

        <!-- 主内容区域 -->
        <Grid Grid.Row="2">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="300" />
            </Grid.ColumnDefinitions>

            <!-- 左侧：窗口列表 -->
            <ui:Border Grid.Column="0"
                       Background="{DynamicResource SolidBackgroundFillColorSecondaryBrush}"
                       BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                       BorderThickness="0,0,1,0">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <!-- 列表标题 -->
                    <ui:Border Grid.Row="0"
                               Background="{DynamicResource SolidBackgroundFillColorTertiaryBrush}"
                               Padding="16,12">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>

                            <ui:TextBlock Grid.Column="0"
                                          Text="可用窗口"
                                          FontWeight="SemiBold"
                                          Foreground="{DynamicResource TextFillColorPrimaryBrush}" />

                            <ui:TextBlock Grid.Column="2"
                                          Text="{Binding AllDisplayWindows.Count, StringFormat='共 {0} 个窗口'}"
                                          FontSize="12"
                                          Foreground="{DynamicResource TextFillColorTertiaryBrush}" />
                        </Grid>
                    </ui:Border>

                    <!-- 窗口列表 -->
                    <ui:DynamicScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                        <Grid>
                            <ItemsControl ItemsSource="{Binding AllDisplayWindows}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <ui:Border Background="Transparent" CornerRadius="8"
                                                   BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                                                   Margin="0,5" Padding="8">
                                            <i:Interaction.Behaviors>
                                                <b:SelectWindowBehavior
                                                    HoverBackgroundBrush="{DynamicResource TextFillColorDisabledBrush}"
                                                    NormalBackgroundBrush="Transparent"
                                                    MouseLeftClickCommand="{Binding DataContext.SelectWindowCommand, RelativeSource={RelativeSource FindAncestor, AncestorType={x:Type local:PickWindowDialog}}}"
                                                    MouseLeftDoubleClickCommand="{Binding DataContext.ConfirmCommand , RelativeSource={RelativeSource FindAncestor, AncestorType={x:Type local:PickWindowDialog}}}"
                                                    CommandParameter="{Binding}" />
                                            </i:Interaction.Behaviors>
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto" />
                                                    <ColumnDefinition Width="*" />
                                                    <ColumnDefinition Width="Auto" />
                                                    <ColumnDefinition Width="Auto" />
                                                    <ColumnDefinition Width="Auto" />
                                                </Grid.ColumnDefinitions>

                                                <!-- 应用图标 -->
                                                <Image Grid.Column="0"
                                                       Source="{Binding Icon}"
                                                       Width="32"
                                                       Height="32"
                                                       Margin="0,0,12,0" />

                                                <!-- 应用信息 -->
                                                <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                    <ui:TextBlock Text="{Binding Title}"
                                                                  FontWeight="SemiBold"
                                                                  Foreground="{DynamicResource TextFillColorPrimaryBrush}"
                                                                  TextTrimming="CharacterEllipsis" />
                                                    <ui:TextBlock Text="{Binding ProcessName}"
                                                                  FontSize="11"
                                                                  Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                                                  TextTrimming="CharacterEllipsis" />
                                                </StackPanel>
                                            </Grid>
                                        </ui:Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>

                            <!-- 加载进度条 -->
                            <controls:LoadingBox
                                VerticalAlignment="Center" HorizontalAlignment="Center"
                                IsActive="{Binding IsLoadingWindows}" LoadingMessage="正在获取窗口列表..." />

                            <!-- 空状态 -->
                            <ui:Border
                                Visibility="{Binding HasWindows, Converter={StaticResource BooleanToVisibleConverter}, ConverterParameter=True}"
                                VerticalAlignment="Center"
                                HorizontalAlignment="Center"
                                Background="Transparent">
                                <StackPanel HorizontalAlignment="Center">
                                    <ui:SymbolIcon Symbol="WindowMultiple20"
                                                   FontSize="48" Margin="0,0,0,12"
                                                   Foreground="{DynamicResource TextFillColorTertiaryBrush}" />
                                    <ui:TextBlock Text="没有找到可用窗口"
                                                  FontSize="14" Margin="0,0,0,12"
                                                  Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                                  HorizontalAlignment="Center" />
                                    <ui:TextBlock Text="请确保目标窗口可见且未被最小化"
                                                  FontSize="12"
                                                  Foreground="{DynamicResource TextFillColorTertiaryBrush}"
                                                  HorizontalAlignment="Center"
                                                  TextAlignment="Center" />
                                </StackPanel>
                            </ui:Border>
                        </Grid>
                    </ui:DynamicScrollViewer>
                </Grid>
            </ui:Border>

            <!-- 右侧：预览面板 -->
            <ui:Border Grid.Column="1" Margin="1,0,0,0"
                       Background="{DynamicResource SolidBackgroundFillColorSecondaryBrush}">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>

                    <!-- 预览标题 -->
                    <ui:Border Grid.Row="0"
                               Background="{DynamicResource SolidBackgroundFillColorTertiaryBrush}"
                               Padding="16,12">
                        <ui:TextBlock Text="窗口预览"
                                      FontWeight="SemiBold"
                                      Foreground="{DynamicResource TextFillColorPrimaryBrush}" />
                    </ui:Border>

                    <!-- 预览内容 -->
                    <ui:DynamicScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" Padding="16"
                                            Visibility="{Binding HasSelectedWindow, Converter={StaticResource BooleanToVisibleConverter}}">
                        <StackPanel>
                            <!-- 实时截图预览 -->
                            <ui:Border Background="{DynamicResource SolidBackgroundFillColorPrimaryBrush}"
                                       CornerRadius="8" Margin="0,0,0,16"
                                       BorderThickness="1"
                                       BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                                       Padding="8">
                                <StackPanel>
                                    <ui:TextBlock Text="实时预览"
                                                  FontWeight="SemiBold"
                                                  Margin="0,0,0,8"
                                                  Foreground="{DynamicResource TextFillColorSecondaryBrush}" />

                                    <Border Background="Black"
                                            CornerRadius="4"
                                            Padding="2">
                                        <Image Source="{Binding SelectedWindowScreenshot}"
                                               Stretch="Uniform"
                                               MaxHeight="200"
                                               HorizontalAlignment="Center"
                                               VerticalAlignment="Center" />
                                    </Border>

                                    <controls:LoadingBox Margin="0,8" HorizontalAlignment="Center"
                                                         LoadingMessage="正在捕获截图..."
                                                         IsActive="{Binding IsCapturingScreenshot}" />

                                </StackPanel>
                            </ui:Border>

                            <!-- 窗口详细信息 -->
                            <ui:Border Background="{DynamicResource SolidBackgroundFillColorPrimaryBrush}"
                                       CornerRadius="8" Margin="0,0,0,16"
                                       BorderThickness="1"
                                       BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                                       Padding="16">
                                <StackPanel>
                                    <ui:TextBlock Text="窗口信息"
                                                  FontWeight="SemiBold" Margin="0,0,0,8"
                                                  Foreground="{DynamicResource TextFillColorSecondaryBrush}" />

                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="Auto" />
                                        </Grid.RowDefinitions>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto" />
                                            <ColumnDefinition Width="*" />
                                        </Grid.ColumnDefinitions>

                                        <ui:TextBlock Grid.Row="0" Grid.Column="0"
                                                      Text="标题:"
                                                      FontTypography="BodyStrong" Margin="0,0,0,8"
                                                      Foreground="{DynamicResource TextFillColorSecondaryBrush}" />
                                        <ui:TextBlock Grid.Row="0" Grid.Column="1"
                                                      Text="{Binding SelectedWindow.Title}"
                                                      VerticalAlignment="Center" TextWrapping="Wrap"
                                                      Margin="8,0,0,8"
                                                      Foreground="{DynamicResource TextFillColorSecondaryBrush}" />

                                        <ui:TextBlock Grid.Row="1" Grid.Column="0"
                                                      Text="进程名:"
                                                      FontTypography="BodyStrong" Margin="0,0,0,8"
                                                      Foreground="{DynamicResource TextFillColorSecondaryBrush}" />
                                        <ui:TextBlock Grid.Row="1" Grid.Column="1"
                                                      Text="{Binding SelectedWindow.ProcessName}"
                                                      VerticalAlignment="Center" TextWrapping="Wrap"
                                                      Margin="8,0,0,8"
                                                      Foreground="{DynamicResource TextFillColorSecondaryBrush}" />

                                        <ui:TextBlock Grid.Row="2" Grid.Column="0"
                                                      Text="文件路径:"
                                                      FontTypography="BodyStrong" Margin="0,0,0,8"
                                                      Foreground="{DynamicResource TextFillColorSecondaryBrush}" />
                                        <ui:TextBlock Grid.Row="2" Grid.Column="1"
                                                      Text="{Binding SelectedWindow.ExecutablePath}"
                                                      VerticalAlignment="Center" TextWrapping="Wrap"
                                                      FontSize="12"
                                                      Margin="8,0,0,8"
                                                      Foreground="{DynamicResource TextFillColorSecondaryBrush}" />

                                        <ui:TextBlock Grid.Row="3" Grid.Column="0"
                                                      Text="句柄:"
                                                      FontTypography="BodyStrong"
                                                      Foreground="{DynamicResource TextFillColorSecondaryBrush}" />
                                        <ui:TextBlock Grid.Row="3" Grid.Column="1"
                                                      Text="{Binding SelectedWindow.Handle, StringFormat='0x{0:X8}'}"
                                                      FontFamily="Consolas" FontSize="12"
                                                      VerticalAlignment="Center" TextWrapping="Wrap"
                                                      Margin="8,0,0,0"
                                                      Foreground="{DynamicResource TextFillColorSecondaryBrush}" />
                                    </Grid>
                                </StackPanel>
                            </ui:Border>
                        </StackPanel>
                    </ui:DynamicScrollViewer>

                    <!-- 无选择提示 -->
                    <ui:Border Grid.Row="1"
                               Visibility="{Binding HasSelectedWindow, Converter={StaticResource BooleanToVisibleConverter}, ConverterParameter=True}"
                               VerticalAlignment="Center" HorizontalAlignment="Center"
                               Background="Transparent">
                        <StackPanel HorizontalAlignment="Center">
                            <ui:SymbolIcon Symbol="Window20"
                                           FontSize="48" Margin="0,0,0,12"
                                           Foreground="{DynamicResource TextFillColorTertiaryBrush}" />
                            <ui:TextBlock Text="选择窗口查看预览"
                                          FontSize="14" Margin="0,0,0,12"
                                          Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                          HorizontalAlignment="Center" />
                            <ui:TextBlock Text="点击左侧列表中的窗口项"
                                          FontSize="12"
                                          Foreground="{DynamicResource TextFillColorTertiaryBrush}"
                                          HorizontalAlignment="Center" />
                        </StackPanel>
                    </ui:Border>

                    <!-- 操作提示 -->
                    <ui:Border Grid.Row="2" Background="{DynamicResource SolidBackgroundFillColorTertiaryBrush}"
                               CornerRadius="8" Margin="10,5" Padding="12">
                        <StackPanel>
                            <ui:TextBlock Text="💡 操作提示"
                                          FontWeight="SemiBold"
                                          FontSize="12" Margin="0,0,0,4"
                                          Foreground="{DynamicResource TextFillColorSecondaryBrush}" />
                            <ui:TextBlock Text="• 单击窗口项可查看预览"
                                          FontSize="11" Margin="0,0,0,4"
                                          Foreground="{DynamicResource TextFillColorTertiaryBrush}" />
                            <ui:TextBlock Text="• 双击窗口项可快速选择"
                                          FontSize="11" Margin="0,0,0,4"
                                          Foreground="{DynamicResource TextFillColorTertiaryBrush}" />
                        </StackPanel>
                    </ui:Border>
                </Grid>
            </ui:Border>
        </Grid>

        <!-- 底部按钮栏 -->
        <ui:Border Grid.Row="3"
                   Background="{DynamicResource SolidBackgroundFillColorSecondaryBrush}"
                   BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                   BorderThickness="0,4,0,0"
                   Padding="20,16">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <!-- 状态信息 -->
                <ui:TextBlock Grid.Column="0"
                              Text="{Binding StatusMessage}"
                              FontSize="12"
                              Foreground="{DynamicResource TextFillColorTertiaryBrush}"
                              VerticalAlignment="Center" />

                <!-- 操作按钮 -->
                <StackPanel Grid.Column="2" Orientation="Horizontal">
                    <ui:Button Content="取消"
                               Appearance="Secondary" Margin="0,0,8,0"
                               Command="{Binding CancelCommand}"
                               MinWidth="80" />

                    <ui:Button Content="确定"
                               Appearance="Primary"
                               Command="{Binding ConfirmCommand}"
                               IsEnabled="{Binding HasSelectedWindow}"
                               MinWidth="80" />
                </StackPanel>
            </Grid>
        </ui:Border>
    </Grid>
</ui:FluentWindow>